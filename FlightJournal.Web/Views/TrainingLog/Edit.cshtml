@using FlightJournal.Web.Views
@model FlightJournal.Web.Models.TrainingLogViewModel

<div class="tourable" data-step="1" data-intro=@Html.Raw(__("On this page, you can plan a training flight based on the current status of the pilot, and you can evaluate and grade the flight. Note that the guide only shows descriptions for currently visible elements, so you may have to open the sections you are interested in"))></div>

<div class="row no-gutter">
    <div class="col-xs-12" data-step="2" data-intro=@Html.Raw(__("Select the training program for this flight. This determines which lessons and exercises you will see below"))>
        <select class="selectpicker" id="TrainingProgram">
            @foreach (var program in Model.TrainingPrograms)
            {
                <option value="@program.Id">@program.Name</option>
            }
        </select>
    </div>
</div>
<div class="row no-gutter" data-step="3" data-intro=@Html.Raw(__("Flight info"))>
    <div class="col-xs-4 col-sm-2">
        @Model.Date
    </div>
    <div class="col-xs-4 col-sm-2">
        @Model.Pilot
    </div>
    <div class="col-xs-4 col-sm-2">
        @Model.BackseatPilot
    </div>
</div>

<div class="row no-gutter btn-group-toggle" data-toggle="buttons" >
    <label class="col-xs-2 btn btn-default traininglogstatebutton" id="lessonoverviewtoggle" data-step="4" data-intro=@Html.Raw(__("Show/hide bar-chart style overview of lessons and their completion"))><input type="checkbox"><i class="fa fa-list"></i><span class="hidden-xs  hidden-sm"> @_("Lesson progress")</span></label>
    <label class="col-xs-2 btn btn-default traininglogstatebutton" id="lessonstoggle" data-step="5" data-intro=@Html.Raw(__("Show/hide buttons to access exercises for each lesson"))><input type="checkbox"><i class="fa fa-paper-plane"></i><span class="hidden-xs hidden-sm"> @_("Lesson details")</span></label>
    <div class="col-xs-2"></div>
    <label class="col-xs-2 btn btn-default traininglogstatebutton" id="maneuverstoggle" data-step="6" data-intro=@Html.Raw(__("Show/hide selection of maneuvers done during the flight"))><input type="checkbox">&#x21B0&#x219D&infin;<span class="hidden-xs  hidden-sm"> @_("Maneuvers")</span></label>
    <label class="col-xs-2 btn btn-default traininglogstatebutton" id="annotationstoggle" data-step="7" data-intro=@Html.Raw(__("Show/hide options for grading the flight phases"))><input type="checkbox">@_("Grading")</label>
    <label class="col-xs-2 btn btn-default traininglogstatebutton" id="weathertoggle" data-step="8" data-intro=@Html.Raw(__("Show/hide options for describing the weather during the flight"))><input type="checkbox"><i class="fa fa-cloud"></i><span class="hidden-xs  hidden-sm"> @_("Weather")</span></label>
</div>

<div id="lessonsoverviewcontainer" class="table-responsive row no-gutter bordered">
    <table class="table table-condensed col-xs-12 lessonsoverviewtable" data-step="10" data-intro=@Html.Raw(__("Progress for each lesson"))>
        <tbody>
        @{
            var introDefCshown = false;
            var introDefWshown = false;
            var introDefNshown = false;
        }
        @foreach (var lesson in Model.TrainingProgram.Lessons)
        {
            var completedpct = (int) Math.Round(100.0 * lesson.ExercisesCompleted / lesson.ExercisesTotal);
            var wippct = (int) Math.Round(100.0 * lesson.ExercisesInProgress / lesson.ExercisesTotal);
            var nspct = 100 - completedpct - wippct;
            var introdefC = "";
            var introdefW = "";
            var introdefN = "";
            if (!introDefCshown && completedpct > 0)
            {
                var introTxt = Html.Raw(__("Number of completed exercises is shown in this style")).ToString();
                introdefC = $"data-step=11 data-tooltipClass=status-completed data-intro={introTxt}";
                introDefCshown = true;
            }
            if (!introDefWshown && wippct > 0)
            {
                var introTxt = Html.Raw(__("Number of exercises in progress is shown in this style")).ToString();
                introdefW = $"data-step=12 data-tooltipClass=status-in-progress data-intro={introTxt}";
                introDefWshown = true;
            }
            if (!introDefNshown && nspct > 0)
            {
                var introTxt = Html.Raw(__("Number of exercises not started yet is shown in this style")).ToString();
                introdefN = $"data-step=13 data-tooltipClass=status-not-started data-intro={introTxt}";
                introDefNshown = true;
            }
            <tr class="@Model.TrainingProgram.Id  lessondetails" data-lessonid="@lesson.Id" >
                <td style="width: 5%; line-height: 0.7;">@lesson.Name</td>
                <td class="progress" style="width: 95%; padding: 0px;">
                @if (completedpct > 0)
                {
                    <div class="progress-bar status-completed" role="progressbar" style="width: @completedpct%" @Html.Raw(introdefC)>@lesson.ExercisesCompleted</div>
                }
                @if (wippct > 0)
                {
                    <div class="progress-bar status-in-progress" role="progressbar" style="width: @wippct%;"  @Html.Raw(introdefW)> @lesson.ExercisesInProgress</div>
                }
                @if (nspct > 0)
                {
                    <div class="progress-bar status-not-started" role="progressbar" style="width: @nspct%;"  @Html.Raw(introdefN)>@lesson.ExercisesNotStarted</div>
                }
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="row no-gutter btn-group-toggle @Model.TrainingProgram.Id lessonscontainer bordered" data-toggle="buttons" data-step="20" data-intro=@Html.Raw(__("Click a button to see the detailed exercise info and status for the lesson"))>
    @foreach (var lesson in Model.TrainingProgram.Lessons)
    {
        <label class="col-xs-2 col-sm-1 traininglogstatebutton btn btn-default @CssHelper.CssClassFor(lesson.Status)" title="@lesson.StatusSummary"><input type="checkbox" data-lessonclz="@Model.TrainingProgram.Id-@lesson.Id" class="lessontoggle">@lesson.Name</label>
    }
    <div class="col-xs-2 col-sm-1 "></div>
</div>



<div id="lessonscontainer" class="table-responsive lessonscontainer row no-gutter bordered" >
    <table class="table table-condensed col-xs-12 lessonsdetailtable" data-step="30" data-intro=@Html.Raw(__("All lessons and exercises with status"))>
        <thead>
            <tr>
                <th>@_("Lesson")</th>
                <th>@_("Exercise")</th>
                <th class="hcenter ">@_("Briefed")</th>
                <th class="hcenter ">@_("Trained")</th>
                <th class="hcenter ">@_("Ok")</th>
                <th class="hcenter ">@_("Briefed")</th>
                <th class="hcenter ">@_("Trained")</th>
                <th class="hcenter ">@_("Ok")</th>
            </tr>
        </thead>
        <tbody>
        @{
            var helpIntroShown = false;
            var statusIntroShown = false;
        }
        @*//TODO: rename to Exercise/ExercisePart (PartialExercise?)*@
        @foreach (var lesson in Model.TrainingProgram.Lessons)
        {
            foreach (var exercise in lesson.Exercises)
            {
                var checkedBox = "<input type='checkbox' checked disabled>";
                var uncheckedBox = "<input type='checkbox' disabled>";
                var newcheckBoxOrPlaceholder = exercise.BriefingOnlyRequired ? "." : "<input type='checkbox' class='lessoncheckbox'>";
                var newcheckBox = "<input type='checkbox' class='lessoncheckbox'>";
                var clz = CssHelper.CssClassFor(exercise.Status);
                var briefedMarker = exercise.IsBriefed ? checkedBox : uncheckedBox;
                var trainedMarker = exercise.BriefingOnlyRequired ? "." : exercise.IsTrained ? checkedBox : uncheckedBox;
                var completedMarker = exercise.BriefingOnlyRequired ? "." : exercise.IsCompleted ? checkedBox : uncheckedBox;
                var infoMarker = exercise.LongDescription.Any() ? "<span class='fa fa-info-circle'></span>" : "";
                var introdefL = "";
                var introdefX = "";
                var introdefB0 = "";
                var introdefT0 = "";
                var introdefC0 = "";
                var introdefB = "";
                var introdefT = "";
                var introdefC = "";
                if (!helpIntroShown && exercise.LongDescription.Any())
                {
                    // show lesson/exercise help on first exercise with long description
                    var introtxtL = Html.Raw(__("Click here to see a description of the lesson")).ToString();
                    introdefL = $"data-step=32 data-intro={introtxtL}";
                    var introtxtX = Html.Raw(__("Click here to see a description of the exercise (if available)")).ToString();
                    introdefX = $"data-step=33 data-intro={introtxtX}";
                    helpIntroShown = true;
                }
                else if (!statusIntroShown && !exercise.BriefingOnlyRequired)
                {
                    var introtxtB0 = Html.Raw(__("Checked if exercise has previously been briefed")).ToString();
                    introdefB0 = $"data-step=34 data-intro={introtxtB0}";
                    var introtxtT0 = Html.Raw(__("Checked if exercise has previously been trained but is not yet at a sufficient level")).ToString();
                    introdefT0 = $"data-step=35 data-intro={introtxtT0}";
                    var introtxtC0 = Html.Raw(__("Checked if exercise has previously been completed")).ToString(); // TODO: highlight at regressions (not ok, but previous flights had ok)
                    introdefC0 = $"data-step=36 data-intro={introtxtC0}";

                    var introtxtB = Html.Raw(__("Check this when the exercise has been briefed on this flight")).ToString();
                    introdefB = $"data-step=37 data-intro={introtxtB}";
                    var introtxtT = Html.Raw(__("Check this when the exercise has been trained on this flight but is not yet at a sufficient level")).ToString();
                    introdefT = $"data-step=38 data-intro={introtxtT}";
                    var introtxtC = Html.Raw(__("Check this when the exercise is completed on this flight")).ToString();
                    introdefC = $"data-step=39 data-intro={introtxtC}";
                    statusIntroShown = true;
                }
                <tr class="@Model.TrainingProgram.Id-@lesson.Id exercise" data-programid='@Model.TrainingProgram.Id' data-lessonid='@lesson.Id' data-exerciseid='@exercise.Id'>
                    <td class="btn-default statusbutton @clz lessondetails" data-lessonid="@lesson.Id"  @Html.Raw(introdefL)>@lesson.Name</td>
                    <td class="btn-default statusbutton @clz exercisedetails" data-exerciseid="@exercise.Id"  @Html.Raw(introdefX)>@exercise.Description @Html.Raw(infoMarker)</td>
                    <td class="btn-default hcenter @clz" @Html.Raw(introdefB0)>@Html.Raw(briefedMarker)</td>
                    <td class="btn-default hcenter @clz" @Html.Raw(introdefT0)>@Html.Raw(trainedMarker)</td>
                    <td class="btn-default hcenter @clz" @Html.Raw(introdefC0)>@Html.Raw(completedMarker)</td>
                    <td class="btn-default hcenter statusbutton chk_briefed annotationcontainer" @Html.Raw(introdefB)>@Html.Raw(newcheckBox)</td>
                    <td class="btn-default hcenter statusbutton chk_trained annotationcontainer" @Html.Raw(introdefT)>@Html.Raw(newcheckBoxOrPlaceholder)</td>
                    <td class="btn-default hcenter statusbutton chk_ok annotationcontainer" @Html.Raw(introdefC)>@Html.Raw(newcheckBoxOrPlaceholder)</td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

<div id="maneuverscontainer" class="row annotationcontainer bordered no-gutter" data-step="40" data-intro=@Html.Raw(@__("Select the maneuvers performed during the flight"))>
    <div class="col-xs-2  col-sm-1">@_("Maneuvers")</div>
    <select class="col-xs-10  col-sm-11 selectpicker userselection" multiple  id="maneuver-sel" title=@Html.Raw(__("Select one or more maneuvers"))>
        @foreach (var maneuver in Model.Manouvres)
        {
            var selected = "";
            if (Model.ThisFlight.Manouvres != null)
            {
                selected = Model.ThisFlight.Manouvres.Contains(maneuver.ManouvreId) ? "selected" : "";
            }
            <option value="@maneuver.ManouvreId" data-icon="@maneuver.IconCssClass" class="manouver" @selected>@Html.Raw(maneuver.ManouvreItem)</option>
        }
    </select>
</div>


<div id="annotationscontainer" class="annotationcontainer bordered row no-gutter" data-step="50" data-intro=@Html.Raw(__("Here you can grade, annotate, and comment the phases of the flight ")) data-id_for_ok="@Model.AnnotationIdForOk">
    <div class="col-xs-12 col-sm-12">
        <button class="btn btn-success" id="sfilok">@_("Everything ok")</button>
    </div>
    <div class="col-xs-2 col-sm-1">@_("Launch")</div>
    <select class="col-xs-10 col-sm-11 selectpicker annotation userselection" id="s-ann" multiple title=@Html.Raw(__("Grade the launch"))>
        @foreach (var annotation in Model.AnnotationsForStartPhase)
        {
            var selected = "";
            if (Model.ThisFlight.StartAnnotations != null)
            {
                selected = Model.ThisFlight.StartAnnotations.Contains(annotation.CommentaryId) ? "selected" : "";
            }
            <option value="@annotation.CommentaryId" @selected class="s_annotation">@Html.Raw(annotation.Comment)</option>
        }
    </select>
    <div class="col-xs-2 col-sm-1">@_("Flight")</div>
    <select class="col-xs-10 col-sm-11  selectpicker annotation userselection" id="f-ann" multiple title=@Html.Raw(__("Grade the flight phase between launch and approach"))>
        @foreach (var annotation in Model.AnnotationsForFlightPhase)
        {
            var selected = "";
            if (Model.ThisFlight.FlightAnnotations != null)
            {
                selected = Model.ThisFlight.FlightAnnotations.Contains(annotation.CommentaryId) ? "selected" : "";
            }
            <option value="@annotation.CommentaryId"  @selected class="f_annotation">@Html.Raw(annotation.Comment)</option>
        }
    </select>
    <div class="col-xs-2 col-sm-1">@_("Approach")</div>
    <select class="col-xs-10  col-sm-11 selectpicker annotation userselection" id="i-ann" multiple title=@Html.Raw(__("Grade the approach phase"))>
        @foreach (var annotation in Model.AnnotationsForApproachPhase)
        {
            var selected = "";
            if (Model.ThisFlight.ApproachAnnotations != null)
            {
                selected = Model.ThisFlight.ApproachAnnotations.Contains(annotation.CommentaryId) ? "selected" : "";
            }
            <option value="@annotation.CommentaryId"  @selected class="i_annotation">@Html.Raw(annotation.Comment)</option>
        }
    </select>
    <div class="col-xs-2 col-sm-1">@_("Landing")</div>
    <select class="col-xs-10 col-sm-11  selectpicker annotation userselection" id="l-ann" multiple title=@Html.Raw(__("Grade the landing"))>
        @foreach (var annotation in Model.AnnotationsForLandingPhase)
        {
            var selected = "";
            if (Model.ThisFlight.LandingAnnotations != null)
            {
                selected = Model.ThisFlight.LandingAnnotations.Contains(annotation.CommentaryId) ? "selected" : "";
            }
            <option value="@annotation.CommentaryId" @selected class="l_annotation">@Html.Raw(annotation.Comment)</option>
        }
    </select>
    <div class="col-xs-2 col-sm-1">@_("Note")</div>
    <div class="col-xs-10 col-sm-11 " data-step="55" data-intro=@Html.Raw(__("If you have comments beyond the predefined selections above, you can enter them here"))>
        <textarea style="width: 100%; max-width:100%" id="flightnotes" rows="3">@Model.ThisFlight.Notes</textarea>
    </div>
</div>

@*TODO: set this according to current data in Model.ThisFlight, and indicate value at entry (for use by change detection) *@
<div id="weathercontainer" class="annotationcontainer bordered row no-gutter" data-step="60" data-intro=@Html.Raw(__("In case the weather has been a factor (for better or worse), you can describe it here"))>
    <div class="col-xs-2  col-sm-1">@_("Weather")</div>
    <select class="col-xs-5 selectpicker userselection" title=@Html.Raw(__("Wind direction")) id="wind_direction">
        @foreach (var v in Model.WindDirections)
        {
            var selected = "";
            if (Model.ThisFlight.Weather != null)
            {
                selected = Model.ThisFlight.Weather.WindDirection.WindDirectionItem == v.Value ? "selected" : "";
            }
            <option value="@v.Value" class="wind_direction" @selected>@Html.Raw(v.Text)</option>
        }
    </select>
    <select class="col-xs-4 selectpicker userselection" title=@Html.Raw(__("Wind speed")) id="wind_speed">
        @foreach (var v in Model.WindSpeeds)
        {
            var selected = "";
            if (Model.ThisFlight.Weather != null)
            {
                selected = Model.ThisFlight.Weather.WindSpeed.WindSpeedItem == v.Value ? "selected" : "";
            }
            <option value="@v.Value" class="wind_speed"@selected>@Html.Raw(v.Text)</option>
        }
    </select>
</div>



<div class="row" style="margin-top: 30px">
    <div class="col-md-6">
        <div class="btn-group btn-group-lg">
            <button class="btn btn-primary" id="savebtn">@_("Save")</button>
            <button class="btn btn-default" id="backbtn">@_("Back")</button>
            <button class="btn btn-default" id="showrecentflights">@_("Show last 15 flights")</button>
        </div>
    </div>
</div>


<div class="modal" tabindex="-1" role="dialog" id="exercisemodal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exercisemodaltitle">@_("Exercise")</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="exercise-description"></p>

                <h4 id="exercise-precondition-header">@_("Preconditions")</h4>
                <p id="exercise-precondition"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="recentflightsmodal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@_("Recent flights")</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="recentflightstable">
                <table class='table table-responsive table-condensed'>
                    @{
                        foreach (var flight in Model.FlightLog)
                        {
                            //TODO Replace with real data
                            <tr><td>@flight.Date</td><td></td><td>Øvet</td><td>Ok - lidt slingrende</td><td></td></tr>
                             
                           }
                        }
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@foreach (var lesson in Model.TrainingProgram.Lessons)
{
    <div class="lessondescription" id="@lesson.Id" data-header="@lesson.Name" data-description="@lesson.Description" data-precondition="@lesson.Precondition"></div>
    foreach (var exercise in lesson.Exercises)
    {
        <div class="exercisedescription" id="@exercise.Id" data-header="@exercise.Description" data-description="@exercise.LongDescription"></div>
    }
}

<div id="urls" data-saveflight="@Url.Action("UpdateTrainingFlight","TrainingLog")"></div>


@section scripts
{
    <script type="text/javascript">
        $(document).ready(function() {
            $("#TrainingProgram").change(function() {
//                showRelevantTrainingProgram($(this));
//TODO: reload with new program
            });

            $(".lessontoggle").change(function() {
                showRelevantExercises($(this));
            });

            $(".exercise").hide();
            $(".lessonsdetailtable").hide();
            $(".lessonsoverviewtable").hide();

            $(".exercisedetails").click(function() {
                showInfoFromId($(this).data("exerciseid"));
            });
            $(".lessondetails").click(function() {
                showInfoFromId($(this).data("lessonid"));
            });

            $("#showrecentflights").click(function() {
                $("#recentflightsmodal").modal();
            });

            $(".lessonscontainer").hide();
            $("#annotationscontainer").hide();
            $("#maneuverscontainer").hide();
            $("#weathercontainer").hide();
            $("#lessonsoverviewcontainer").hide();


            $("#maneuverstoggle").click(function() {
                if ($(this).find("input").is(":checked"))
                    $("#maneuverscontainer").hide();
                else
                    $("#maneuverscontainer").show();
            });
            $("#annotationstoggle").click(function() {
                if ($(this).find("input").is(":checked"))
                    $("#annotationscontainer").hide();
                else
                    $("#annotationscontainer").show();
            });
            $("#weathertoggle").click(function() {
                if ($(this).find("input").is(":checked"))
                    $("#weathercontainer").hide();
                else
                    $("#weathercontainer").show();
            });
            $("#lessonoverviewtoggle").click(function() {
                if ($(this).find("input").is(":checked")) {
                    $("#lessonsoverviewcontainer").hide();
                    $(".lessonsoverviewtable").hide();
                } else {
                    $("#lessonsoverviewcontainer").show();
                    $(".lessonsoverviewtable").show();
                }
            });
            $("#lessonstoggle").click(function() {
                if ($(this).find("input").is(":checked"))
                    $(".lessonscontainer").hide();
                else
                    $(".lessonscontainer").show();
            });

            $("#sfilok").click(function () {
                var id = $("#annotationscontainer").data("id_for_ok")
                $(".selectpicker.annotation").each(function() {
                    $(this).selectpicker('val', id); //TODO: repair
                });
            });

            $("#savebtn").click(function() {
                if (!isDirty())
                    window.history.back();
                else {
                    saveFlightData();
                    window.history.back();
                }

            });
            //TODO: also detect simple tab close, and react similarly
            $("#backbtn").click(function() {
                if (!isDirty() ||
                    confirm(@Html.Raw(__("You have unsaved data - do you want to leave the page and loose the changes?")))) {
                    window.history.back();
                }
            });
        });

        var isDirty = function() {
            var exerciseDataChanged = $(".lessoncheckbox:checked").length > 0;
            var annotationCount = 0;
            $(".userselection").each(function() { if ($(this).val()) ++annotationCount; });
            var hasNote = $("#flightnotes").val().length > 0;
            return exerciseDataChanged || hasNote || annotationCount > 0;
        }

        var showRelevantExercises = function(lesson) {
            $(".lessonsdetailtable").show();
            var key = "." + lesson.data("lessonclz");
            $(key).each(function() {
                if (lesson.is(":checked"))
                    $(this).show();
                else
                    $(this).hide();
            });
            var anyLessons = $(".lessontoggle:checked").length;
            if (anyLessons)
                $(".lessonsdetailtable").show();
            else
                $(".lessonsdetailtable").hide();
        }

        @*var showRelevantTrainingProgram = function(sel) {
                <text>
                    if (sel.find(":selected").val() == "@Model.TrainingProgram.Id")
                        $(".@Model.TrainingProgram.Id").show();
                    else
                        $(".@Model.TrainingProgram.Id").hide();
                </text>
            $(".active").removeClass("active");
            $(".exercise").hide();
        }*@


        var showInfoFromId = function(infoid) {
            var info = $("#" + infoid);
            var descr = info.data("description");
            var precondition = info.data("precondition");
            var title = info.data("header");
            if (descr && descr.length) {
                $("#exercisemodaltitle").html(title);
                $("#exercise-description").html(descr);
                $("#exercise-precondition").html(precondition ? precondition : "");
                if (precondition)
                    $("#exercise-precondition-header").show();
                else
                    $("#exercise-precondition-header").hide();
                $("#exercisemodal").modal();
            }
        }


        var saveFlightData = function() {
            // collect changed data from UI and post back

            // status for all exercises
            var exercises = [];
            $(".exercise").each(function(i, e) {
                var ex = {
                    programId: $(this).data("programid"),
                    lessonId: $(this).data("lessonid"),
                    exerciseId: $(this).data("exerciseid"),
                    briefed: $(this).find(".chk_briefed").find(".lessoncheckbox").prop("checked"),
                    trained: $(this).find(".chk_trained").find(".lessoncheckbox").prop("checked"),
                    ok: $(this).find(".chk_ok").find(".lessoncheckbox").prop("checked"),
                };
                exercises.push(ex);
            });

            // manouvers 
            var manouverIds = [];
            $("option.manouver:selected").each(function() { manouverIds.push($(this).val()); });

            // annotations
            var s_annotations = [];
            var f_annotations = [];
            var i_annotations = [];
            var l_annotations = [];
            $("option.s_annotation:selected").each(function () { s_annotations.push($(this).val()); });
            $("option.f_annotation:selected").each(function () { f_annotations.push($(this).val()); });
            $("option.i_annotation:selected").each(function () { i_annotations.push($(this).val()); });
            $("option.l_annotation:selected").each(function () { l_annotations.push($(this).val()); });

            // entire flight
            var flightData = JSON.stringify({
                flightId: "@Model.FlightId",
                exercises: exercises,
                manouverIds: manouverIds,
                note: $("#flightnotes").val(),
                s_annotationIds: s_annotations,
                f_annotationIds: f_annotations,
                i_annotationIds: i_annotations,
                l_annotationIds: l_annotations,
                wind_direction: $("option.wind_direction:selected").val(),
                wind_speed: $("option.wind_speed:selected").val()
            });

            var url = $("#urls").data("saveflight");
            // Post
            $.ajax({
                url: url,
                data: flightData,
                contentType: "application/json; charset=utf-8",
                type: "POST",
                dataType: "json",
                success: function(d) {

                },
                error: function(a, b, c) {

                },
            });
        }

        var checkboxChanged = function(chk) {
            return chk && chk.prop("checked") != chk.hasClass("checkedatentry");
        };
    </script>
}
